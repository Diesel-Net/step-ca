# docker-compose.yaml

version: '3.8'
services: 

  server:
    image: smallstep/step-ca:0.15.4
    volumes:
      - /etc/localtime:/etc/localtime
      - {{ ssl_cert_dir }}/:/etc/ssl/certs/
      - {{ config_dir }}/:/home/step/
    networks:
      - {{ docker_network }}
    deploy:
      labels:
        - traefik.enable=true
       
        - traefik.http.services.{{ git_repository }}.loadbalancer.server.port=443
        - traefik.http.services.{{ git_repository }}.loadbalancer.server.scheme=https

        - traefik.tcp.routers.{{ git_repository }}.rule=HostSNI(`{{ domain }}`)
        - traefik.tcp.routers.{{ git_repository }}.tls.passthrough=true

        #- traefik.tcp.routers.{{ git_repository }}.service={{ git_repository }}@docker
networks:
  {{ docker_network }}:
    external:
      name: {{ docker_network }}
